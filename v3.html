<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Scene Video Prompt Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .form-input, .form-textarea, .form-select, .form-checkbox {
             background-color: #1f2937; border: 1px solid #374151;
             border-radius: 0.5rem; color: #d1d5db;
        }
        .form-checkbox { color: #4f46e5; }
        .form-input::placeholder, .form-textarea::placeholder { color: #6b7280; }
        .mode-btn.active { background-color: #4f46e5; color: white; }
        .hidden { display: none !important; }
        .dynamic-item, .scene-block { border-left: 2px solid #374151; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative">
        <header class="text-center mb-8">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-purple-400 via-indigo-400 to-blue-400 text-transparent bg-clip-text">
                Advanced Video & Image Prompt Builder
            </h1>
            <p class="text-gray-400 mt-2">Craft detailed, structured prompts and export to JSON.</p>
             <div class="mt-6 flex justify-center gap-2">
                <div class="inline-flex rounded-lg bg-gray-800 p-1">
                    <button id="videoModeBtn" class="mode-btn active px-4 py-2 text-sm font-semibold rounded-md transition-colors">Video</button>
                    <button id="imageModeBtn" class="mode-btn px-4 py-2 text-sm font-semibold rounded-md transition-colors text-gray-400">Image</button>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input Form -->
            <div id="form-panel" class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl border border-gray-700 self-start">
                <form id="prompt-form" class="space-y-6">
                    <div id="scenes-container" class="space-y-8">
                        <!-- Scenes will be dynamically inserted here -->
                    </div>
                    <button type="button" id="addSceneBtn" class="w-full text-md bg-green-600/80 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition">+ Add Scene</button>
                </form>
            </div>

            <!-- Right Column: JSON Output -->
            <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl border border-gray-700 h-full flex flex-col">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-100">JSON Output</h2>
                </div>
                 <div class="mb-4 space-y-3">
                     <div class="flex items-center gap-3">
                         <button id="copyBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2.5 px-4 rounded-lg transition duration-300">Copy JSON</button>
                         <button id="loadJsonBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2.5 px-4 rounded-lg transition duration-300">Load from File</button>
                         <input type="file" id="file-input" class="hidden" accept=".json">
                     </div>
                     <div class="flex items-center gap-3">
                         <input type="text" id="fileNameInput" class="form-input w-full p-2.5" value="prompt.json">
                         <button id="saveJsonBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-5 rounded-lg transition duration-300">Save</button>
                     </div>
                </div>
                <div class="flex-grow bg-gray-900 rounded-lg p-1 overflow-auto">
                    <textarea id="json-output" class="w-full h-full min-h-[400px] bg-transparent text-sm text-green-300 rounded-lg p-3 resize-none border-none outline-none shadow-none"></textarea>
                </div>
            </div>
        </main>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA DEFINITIONS ---
        const visualData = {
            artDirection: [
                { field: "Overall Aesthetic", dropdown: ["Cinematic", "Filmic", "Photorealistic", "Hyper-realistic", "Surreal", "Abstract", "Stylized", "Minimalist", "Maximalist", "Grunge", "Psychedelic", "Whimsical", "Epic scale", "Intimate", "Magical realism", "Baroque", "Fantasy art style", "Vaporwave", "Experimental"] },
                { field: "Genre & Theme", dropdown: ["Science fiction", "Fantasy", "Horror", "Thriller", "Mystery", "Romance", "Comedy", "Action/Adventure", "Superhero", "Noir detective", "Western", "Post-apocalyptic", "Dystopian", "Utopian", "Medieval", "Historical drama", "War film", "Spy/Espionage", "Crime drama", "Mythological", "Steampunk", "Cyberpunk", "Space opera", "Zombie apocalypse", "Supernatural", "Fairy tale", "Slice of life", "Musical", "Documentary style", "Film noir"] },
                { field: "Color & Tone", dropdown: ["Vibrant colors", "Saturated", "Desaturated", "Muted palette", "Monochrome", "Black and white", "Sepia", "High contrast colors", "Low contrast colors", "Pastel tones", "Neon colors", "Earth tones", "Teal and orange", "Bleach bypass", "Golden tint", "Color pop", "Retro color grading", "Cross-processed", "Duo-tone", "Moody blue tones"] },
                { field: "Animation Style", dropdown: ["2D animation", "3D animation", "Hand-drawn", "Anime", "Cartoon", "Motion graphics", "Stop-motion", "Claymation", "Live-action", "Mixed media", "Rotoscoping", "Cut-out animation", "Pixel art", "Low-poly CGI", "Vector art", "CGI realism", "Cel animation", "Whiteboard animation", "Unreal Engine cinematic"] },
                { field: "Composition", dropdown: ["Rule of thirds", "Centered composition", "Symmetrical framing", "Asymmetrical", "Leading lines", "Frame within a frame", "Shallow depth of field", "Deep focus", "Negative space", "Filled frame", "Golden ratio", "Triangular composition", "Silhouette composition"] }
            ],
            cinematography: [
                { field: "Lighting Style", dropdown: ["Natural lighting", "Soft light", "Hard light", "High-key", "Low-key", "Backlight", "Rim lighting", "Side lighting", "Ambient light", "Practical lighting", "Neon lighting", "Candlelight", "Golden hour", "Blue hour", "Moonlight", "Silhouette", "Chiaroscuro", "Volumetric light", "Flashing strobe", "Color gel lighting", "Dappled light"] },
                { field: "Camera Movement", dropdown: ["Static shot", "Pan", "Tilt", "Zoom in/out", "Dolly in/out", "Tracking shot", "Crane shot", "Steadicam", "Handheld shaky", "Gimbal", "Drone/Aerial", "Arc shot", "Whip pan", "Push in", "Pull out", "360-degree shot", "Slow motion movement", "Vertigo shot (dolly zoom)"] },
                { field: "Shot Type & Angle", dropdown: ["Eye-level", "High-angle", "Low-angle", "Bird’s-eye view", "Dutch angle", "Over-the-shoulder (OTS)", "Point-of-view (POV)", "Close-up (CU)", "Extreme close-up (ECU)", "Medium shot", "Long shot / Wide shot", "Establishing shot", "Two-shot", "Reaction shot", "Insert shot"] },
                { field: "Lens & Filter Effects", dropdown: ["Bokeh", "Lens flare", "Anamorphic flare", "Fish-eye distortion", "Wide-angle distortion", "Telephoto compression", "Macro", "Tilt-shift", "Soft focus", "Vignette", "Film grain", "VHS glitch", "Chromatic aberration", "HDR effect", "Motion blur", "Long exposure", "Double exposure", "Kaleidoscope"] },
                { field: "Editing & Special Effects", dropdown: ["Slow motion", "Fast motion", "Time-lapse", "Freeze frame", "Bullet time", "Montage", "Split screen", "Match cut", "Jump cut", "Crossfade/Dissolve", "Fade to black", "Dream sequence", "Flashback", "CGI effects", "Practical effects", "Pyrotechnics", "Speed ramping"] },
                { field: "Film Format & Texture", dropdown: ["35mm film", "16mm film", "8mm film", "VHS look", "4K UHD", "IMAX format", "Found footage style", "Newsreel style", "Polaroid look", "Overexposed", "Underexposed", "Dust and scratches", "Clean digital", "Cinemascope"] },
                { field: "Shutter Angle", dropdown: ["180d", "90d", "270d", "360d", "45d", "1d (no motion blur)"] }
            ]
        };

        // --- DOM Elements ---
        const getEl = (id) => document.getElementById(id);
        const dom = {
            videoModeBtn: getEl('videoModeBtn'), imageModeBtn: getEl('imageModeBtn'),
            promptForm: getEl('prompt-form'), jsonOutput: getEl('json-output'),
            saveJsonBtn: getEl('saveJsonBtn'), loadJsonBtn: getEl('loadJsonBtn'),
            fileInput: getEl('file-input'), copyBtn: getEl('copyBtn'), fileNameInput: getEl('fileNameInput'),
            scenesContainer: getEl('scenes-container'), addSceneBtn: getEl('addSceneBtn')
        };
        
        // --- State ---
        let generationMode = 'video';
        let sceneIndex = 0;

        // --- UI & SCENE MANAGEMENT ---
        const addScene = (sceneData = {}) => {
            const sIndex = sceneIndex++;
            const sceneEl = document.createElement('div');
            sceneEl.className = 'scene-block p-4 space-y-6 bg-gray-900/40 rounded-lg relative';
            sceneEl.id = `scene-${sIndex}`;

            const artDirectionFields = visualData.artDirection.map(item => createDropdownField(item, `scenes[${sIndex}].art_direction`, sceneData.art_direction)).join('');
            const cinematographyFields = visualData.cinematography.map(item => createDropdownField(item, `scenes[${sIndex}].cinematography`, sceneData.cinematography)).join('');
            
            sceneEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-purple-300">Scene #${sIndex + 1}</h3>
                    <button type="button" class="text-sm text-red-400 hover:text-red-300 font-semibold" onclick="document.getElementById('scene-${sIndex}').remove(); updateJsonFromForm();">Remove</button>
                </div>
                
                <!-- Scene & Action -->
                <fieldset class="fieldset border border-gray-700 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-200 px-2">🎬 Scene & Action</legend>
                    <div class="space-y-4 mt-2">
                        <div>
                            <label for="scene-summary-${sIndex}" class="block mb-2 text-sm font-medium text-gray-300">Scene Summary</label>
                            <textarea id="scene-summary-${sIndex}" data-path="scenes[${sIndex}].action.summary" rows="3" class="form-textarea w-full p-3" placeholder="A brief, high-level description of the entire action...">${sceneData.action?.summary || ''}</textarea>
                        </div>
                        <div id="characters-container-${sIndex}" class="space-y-4"></div>
                        <button type="button" class="add-character-btn w-full text-sm bg-indigo-600/50 hover:bg-indigo-600/80 text-white font-medium py-2 px-4 rounded-lg transition" data-scene-index="${sIndex}">+ Add Character</button>
                    </div>
                </fieldset>
                
                <!-- Dialogue & Sound -->
                <fieldset class="dialogue-sound-section fieldset border border-gray-700 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-200 px-2">🗣️ Dialogue & Sound</legend>
                    <div class="space-y-4 mt-2">
                        <div>
                            <label for="ambient-sound-${sIndex}" class="block mb-2 text-sm font-medium text-gray-300">Ambient Sound</label>
                            <input type="text" id="ambient-sound-${sIndex}" data-path="scenes[${sIndex}].sound.ambient" class="form-input w-full p-3" placeholder="e.g., Heavy rain against glass, distant city hum..." value="${sceneData.sound?.ambient || ''}">
                        </div>
                        <div id="dialogue-lines-container-${sIndex}" class="space-y-4"></div>
                        <button type="button" class="add-dialogue-btn w-full text-sm bg-indigo-600/50 hover:bg-indigo-600/80 text-white font-medium py-2 px-4 rounded-lg transition" data-scene-index="${sIndex}">+ Add Dialogue Line</button>
                        <div id="sfx-container-${sIndex}" class="space-y-4 mt-4"></div>
                        <button type="button" class="add-sfx-btn w-full text-sm bg-indigo-600/50 hover:bg-indigo-600/80 text-white font-medium py-2 px-4 rounded-lg transition mt-4" data-scene-index="${sIndex}">+ Add Sound Effect (SFX)</button>
                    </div>
                </fieldset>

                <!-- Art Direction -->
                <fieldset class="fieldset border border-gray-700 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-200 px-2">🎨 Art Direction & Style</legend>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6 mt-4">${artDirectionFields}</div>
                </fieldset>
                
                <!-- Cinematography -->
                <fieldset class="cinematography-section fieldset border border-gray-700 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-200 px-2">🎥 Cinematography</legend>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6 mt-4">${cinematographyFields}</div>
                </fieldset>
                
                <!-- Specs -->
                <div class="video-specs-section">
                    <fieldset class="fieldset border border-gray-700 p-4 rounded-lg">
                        <legend class="text-lg font-semibold text-gray-200 px-2">⚙️ Video Specs</legend>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6 mt-4">
                            <div>
                                <label for="duration-${sIndex}" class="block mb-2 text-sm font-medium text-gray-300">Duration</label>
                                <input type="text" id="duration-${sIndex}" data-path="scenes[${sIndex}].specs.duration" class="form-input w-full p-3" placeholder="e.g., 8s" value="${sceneData.specs?.duration || ''}">
                            </div>
                             <div>
                                <label for="fps-${sIndex}" class="block mb-2 text-sm font-medium text-gray-300">FPS</label>
                                <input type="number" id="fps-${sIndex}" data-path="scenes[${sIndex}].specs.fps" class="form-input w-full p-3" placeholder="e.g., 24" value="${sceneData.specs?.fps || ''}">
                            </div>
                         </div>
                    </fieldset>
                </div>
                <div class="image-specs-section hidden">
                     <fieldset class="fieldset border border-gray-700 p-4 rounded-lg">
                        <legend class="text-lg font-semibold text-gray-200 px-2">⚙️ Image Specs</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6 mt-4">
                            <div>
                                <label for="image-aspect-ratio-${sIndex}" class="block mb-2 text-sm font-medium text-gray-300">Aspect Ratio</label>
                                <input type="text" id="image-aspect-ratio-${sIndex}" data-path="scenes[${sIndex}].specs.aspectRatio" class="form-input w-full p-3" placeholder="e.g., 16:9, 1:1" value="${sceneData.specs?.aspectRatio || ''}">
                            </div>
                        </div>
                    </fieldset>
                </div>
            `;
            dom.scenesContainer.appendChild(sceneEl);
            
            // Populate dynamic sub-elements
            if (sceneData.action?.characters) sceneData.action.characters.forEach(charData => addCharacter(sIndex, charData));
            if (sceneData.sound?.dialogue) sceneData.sound.dialogue.forEach(dialogueData => addDialogueLine(sIndex, dialogueData));
            if (sceneData.sound?.sfx) sceneData.sound.sfx.forEach(sfxData => addSfx(sIndex, sfxData));
        };

        const addCharacter = (sIndex, data = {}) => {
            const container = getEl(`characters-container-${sIndex}`);
            const cIndex = container.children.length;
            const div = document.createElement('div');
            div.className = 'dynamic-item p-4 space-y-3 bg-gray-900/50 rounded-lg';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-gray-300">Character #${cIndex + 1}</h4>
                    <button type="button" class="text-xs text-red-400 hover:text-red-300" onclick="this.parentElement.parentElement.remove(); updateJsonFromForm();">Remove</button>
                </div>
                <input type="text" data-path="scenes[${sIndex}].action.characters[${cIndex}].name" class="form-input w-full p-2" placeholder="Character Name/ID (e.g., Detective Alves)" value="${data.name || ''}">
                <textarea data-path="scenes[${sIndex}].action.characters[${cIndex}].description" class="form-textarea w-full p-2" rows="2" placeholder="Description (e.g., Man in his 40s, tired eyes...)">${data.description || ''}</textarea>
                <textarea data-path="scenes[${sIndex}].action.characters[${cIndex}].action" class="form-textarea w-full p-2" rows="3" placeholder="Action (e.g., Sits at a desk, sips coffee...)">${data.action || ''}</textarea>
            `;
            container.appendChild(div);
        };
        
        const addDialogueLine = (sIndex, data = {}) => {
            const container = getEl(`dialogue-lines-container-${sIndex}`);
            const dIndex = container.children.length;
            const div = document.createElement('div');
            div.className = 'dynamic-item p-4 space-y-3 bg-gray-900/50 rounded-lg';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-gray-300">Dialogue Line #${dIndex + 1}</h4>
                    <button type="button" class="text-xs text-red-400 hover:text-red-300" onclick="this.parentElement.parentElement.remove(); updateJsonFromForm();">Remove</button>
                </div>
                <input type="text" data-path="scenes[${sIndex}].sound.dialogue[${dIndex}].character" class="form-input w-full p-2" placeholder="Character Name" value="${data.character || ''}">
                <input type="text" data-path="scenes[${sIndex}].sound.dialogue[${dIndex}].line" class="form-input w-full p-2" placeholder="Line of dialogue" value="${data.line || ''}">
                <input type="text" data-path="scenes[${sIndex}].sound.dialogue[${dIndex}].delivery" class="form-input w-full p-2" placeholder="Delivery (e.g., Whispering, Shouting)" value="${data.delivery || ''}">
            `;
            container.appendChild(div);
        };
        
        const addSfx = (sIndex, data = {}) => {
            const container = getEl(`sfx-container-${sIndex}`);
            const sfxIndex = container.children.length;
            const div = document.createElement('div');
            div.className = 'dynamic-item p-4 space-y-3 bg-gray-900/50 rounded-lg';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-gray-300">Sound Effect #${sfxIndex + 1}</h4>
                    <button type="button" class="text-xs text-red-400 hover:text-red-300" onclick="this.parentElement.parentElement.remove(); updateJsonFromForm();">Remove</button>
                </div>
                <input type="text" data-path="scenes[${sIndex}].sound.sfx[${sfxIndex}].time" class="form-input w-full p-2" placeholder="Time (e.g., 00:09)" value="${data.time || ''}">
                <input type="text" data-path="scenes[${sIndex}].sound.sfx[${sfxIndex}].effect" class="form-input w-full p-2" placeholder="SFX Description (e.g., Loud thunderclap)" value="${data.effect || ''}">
            `;
            container.appendChild(div);
        };

        const createDropdownField = (item, basePath, data = {}) => {
            const fieldId = item.field.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const path = `${basePath}.${fieldId}`;
            const selectedValue = path.split('.').slice(1).reduce((o, k) => (o || {})[k], data) || '';
            const options = item.dropdown.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">${item.field}</label>
                    <select data-path="${path}" class="form-select w-full p-3 rounded-lg">
                        <option value="">Select...</option>
                        ${options}
                    </select>
                </div>`;
        };
        
        const setGenerationMode = (newMode) => {
            generationMode = newMode;
            const isVideo = newMode === 'video';
            dom.videoModeBtn.classList.toggle('active', isVideo);
            dom.imageModeBtn.classList.toggle('active', !isVideo);
            
            document.querySelectorAll('.dialogue-sound-section, .cinematography-section, .video-specs-section').forEach(el => el.classList.toggle('hidden', !isVideo));
            document.querySelectorAll('.image-specs-section').forEach(el => el.classList.toggle('hidden', isVideo));
            
            // For image mode, we only want one scene
            dom.addSceneBtn.classList.toggle('hidden', !isVideo);
            if (!isVideo && dom.scenesContainer.children.length > 1) {
                while (dom.scenesContainer.children.length > 1) {
                    dom.scenesContainer.lastChild.remove();
                }
            }
            updateJsonFromForm();
        };

        // --- Core Application Logic (Form <-> JSON) ---
        window.updateJsonFromForm = () => {
            if (document.activeElement.id === 'json-output') return;
            const data = {};
            const formFields = Array.from(dom.promptForm.querySelectorAll('[data-path]'));
            
            const set = (obj, path, val) => {
                const keys = path.replace(/\[(\d+)\]/g, '.$1').split('.');
                keys.slice(0, -1).reduce((acc, key, i) => {
                    if (!acc[key]) acc[key] = isNaN(parseInt(keys[i + 1])) ? {} : [];
                    return acc[key];
                }, obj)[keys[keys.length - 1]] = val;
            };

            formFields.forEach(el => {
                if (el.closest('.hidden')) return;
                const path = el.dataset.path;
                const value = el.value.trim();
                if (value) set(data, path, value);
            });
            
            // Clean up any empty items from arrays
            if (data.scenes) {
                data.scenes = data.scenes.filter(Boolean);
                data.scenes.forEach(scene => {
                    if (scene?.action?.characters) scene.action.characters = scene.action.characters.filter(Boolean);
                    if (scene?.sound?.dialogue) scene.sound.dialogue = scene.sound.dialogue.filter(Boolean);
                    if (scene?.sound?.sfx) scene.sound.sfx = scene.sound.sfx.filter(Boolean);
                });
            }
            
            dom.jsonOutput.value = JSON.stringify(data, null, 2);
        };

        const populateUIFromData = (data) => {
            dom.scenesContainer.innerHTML = '';
            sceneIndex = 0;
            if (data.scenes && Array.isArray(data.scenes)) {
                data.scenes.forEach(sceneData => addScene(sceneData));
            } else {
                addScene(); // Add one empty scene if none exist
            }
            updateJsonFromForm();
        };

        const updateFormFromJson = () => {
            try {
                const data = JSON.parse(dom.jsonOutput.value);
                populateUIFromData(data);
            } catch (e) {
                console.error("Invalid JSON:", e);
            }
        };
        
        // --- FILE HANDLING & UTILS ---
        const saveJsonToFile = () => {
            let fileName = dom.fileNameInput.value.trim() || "prompt.json";
            if (!fileName.toLowerCase().endsWith('.json')) fileName += '.json';
            const blob = new Blob([dom.jsonOutput.value], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = fileName;
            a.click(); URL.revokeObjectURL(a.href); a.remove();
        };

        const loadJsonFromFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                dom.jsonOutput.value = e.target.result;
                updateFormFromJson();
            };
            reader.readAsText(file);
            event.target.value = ''; 
        };
        
        const copyJsonToClipboard = () => {
            navigator.clipboard.writeText(dom.jsonOutput.value).then(() => {
                const originalText = dom.copyBtn.textContent;
                dom.copyBtn.textContent = "Copied!";
                setTimeout(() => { dom.copyBtn.textContent = "Copy JSON"; }, 2000);
            });
        };
        
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // --- INITIALIZATION ---
        const init = () => {
            dom.promptForm.addEventListener('input', debounce(updateJsonFromForm, 250));
            dom.jsonOutput.addEventListener('input', debounce(updateFormFromJson, 400));
            
            dom.addSceneBtn.addEventListener('click', () => addScene());
            
            // Event delegation for dynamic buttons
            dom.promptForm.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.add-character-btn')) {
                    addCharacter(target.dataset.sceneIndex);
                } else if (target.matches('.add-dialogue-btn')) {
                    addDialogueLine(target.dataset.sceneIndex);
                } else if (target.matches('.add-sfx-btn')) {
                    addSfx(target.dataset.sceneIndex);
                }
                updateJsonFromForm();
            });
            
            dom.videoModeBtn.addEventListener('click', () => setGenerationMode('video'));
            dom.imageModeBtn.addEventListener('click', () => setGenerationMode('image'));
            dom.saveJsonBtn.addEventListener('click', saveJsonToFile);
            dom.loadJsonBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', loadJsonFromFile);
            dom.copyBtn.addEventListener('click', copyJsonToClipboard);
            
            addScene(); // Start with one scene
            setGenerationMode('video');
            updateJsonFromForm();
        };
        
        init();
    });
    </script>
</body>
</html>
